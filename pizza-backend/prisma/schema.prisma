generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  fullName  String    @map("full_name") @db.VarChar(200)
  email     String    @unique @db.VarChar(200)
  password  String
  role      ERole
  sessions  Session[]
  orders    Order[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

model Session {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId    String   @unique @map("device_id")
  tokenPairId String   @unique @map("token_pair_id")
  expiredAt   DateTime @map("expired_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("sessions")
}

model Region {
  id     Int    @id @default(autoincrement())
  title  String
  cities City[]

  @@map("regions")
}

model City {
  id       Int     @id @default(autoincrement())
  title    String
  regionId Int     @map("region_id")
  region   Region  @relation(fields: [regionId], references: [id], onDelete: Cascade)
  orders   Order[]

  @@map("cities")
}

model Category {
  id       Int       @id @default(autoincrement())
  title    String
  products Product[]

  @@map("categories")
}

model Product {
  id            Int            @id @default(autoincrement())
  title         String
  description   String?        @db.VarChar(500)
  price         Int
  imageUrl      String         @map("image_url")
  categoryId    Int            @map("category_id")
  category      Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  ingredients   Ingredient[]
  orderProducts OrderProduct[]
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@map("products")
}

model Ingredient {
  id                      Int                      @id @default(autoincrement())
  title                   String
  price                   Int
  imageUrl                String                   @map("image_url")
  productId               Int                      @map("product_id")
  product                 Product                  @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderProductIngredients OrderProductIngredient[]
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")

  @@map("ingredients")
}

model Order {
  id            Int            @id @default(autoincrement())
  description   String?        @db.VarChar(500)
  phone         String         @db.VarChar(50)
  address       String         @db.VarChar(200)
  status        EOrderStatus   @default(CREATED)
  cityId        Int            @map("city_id")
  city          City           @relation(fields: [cityId], references: [id], onDelete: Cascade)
  userId        Int            @map("user_id")
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderProducts OrderProduct[]
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderProduct {
  id                      Int                      @id @default(autoincrement())
  amount                  Int
  productId               Int                      @map("product_id")
  product                 Product                  @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderId                 Int                      @map("order_id")
  order                   Order                    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderProductIngredients OrderProductIngredient[]
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")

  @@unique([orderId, productId])
  @@map("order_product")
}

model OrderProductIngredient {
  orderProductId Int          @map("orderProduct_id")
  orderProduct   OrderProduct @relation(fields: [orderProductId], references: [id], onDelete: Cascade)
  ingredientId   Int          @map("ingredient_id")
  ingredient     Ingredient   @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@id([orderProductId, ingredientId])
  @@map("order_product_ingredients")
}

enum ERole {
  USER
  DELIVERY
  ADMIN
}

enum EOrderStatus {
  CREATED
  DONE
  CANCELLED
  REJECTED
}
